#!/bin/bash

PLUGIN=$(basename $0)

SLABLOG=$(mktemp)
PS_LWD=$(mktemp -d)
MAX_SECS_IN_LOOP=120

# Check to see if journalctl exists.
if command -v journalctl 2> /dev/null; then
    JOURNALCTL=true
    LOGFILE=/mnt/testarea/journalctl
else
    JOURNALCTL=false
    LOGFILE=/var/log/messages
fi

function WatchFile ()
{
    FILE=$1

    TMPFILE=$(mktemp -p /mnt/testarea -t Watch.XXXXX)
    # Using Bash feature variable 'SECONDS' which keeps count of SECONDS
    # as the script is running. Do not 'unset' SECONDS as it will
    # change it to a regular variable.
    SECONDS=0
    while [ $SECONDS -lt $MAX_SECS_IN_LOOP ]; do
        if [ $JOURNALCTL = true ]; then
            journalctl -b > $FILE
        fi
        diff=$(diff -q $FILE $TMPFILE)
        rc=$?
        if [ $rc -eq 1 ]; then
            cat $FILE > $TMPFILE
        else
            rm $TMPFILE
            break
        fi
        sleep 2
    done
    return $rc
}

# Verbose tree view of running processes:

ps -elfH > $PS_LWD/ps-lwd.log
rstrnt-report-log -l $PS_LWD/ps-lwd.log
rm -rf $PS_LWD

# Get some system information from the system

PROCLIST='m t w'

logger -p local2.info "Gathering System Tasks and Memory Summary Started" -t "restraintd"
for p in $PROCLIST ; do
    # Dump a list of blocked tasks and their information
    echo $p > /proc/sysrq-trigger
done
# Pause until logfile has quiesced.
WatchFile $LOGFILE
rc=$?
if [[ $rc -eq 0 ]]; then
    logger -p local2.info "Gathering System Tasks and Memory Summary Completed" -t "restraintd"
elif [[ $rc -eq 1 ]]; then
    logger -p local2.warning "Gathering System Resources exceeded time" -t "restraintd"
else
    logger -p local2.warning "Gathering System Resources failed rc=$rc" -t "restraintd"
fi

# Send slab info to a file for logging
timestamp=$(/bin/date '+%F %T')
echo "Dumping slabinfo - Start - $timestamp" >> $SLABLOG
cat /proc/slabinfo >> $SLABLOG
timestamp=$(/bin/date '+%F %T')
echo "Dumping slabinfo - Stop - $timestamp" >> $SLABLOG
logger -p local2.info -t "SlabCacheInfo" -f $SLABLOG

if [ $JOURNALCTL = true ]; then
    journalctl -b > $LOGFILE
fi

# Submit dmesg log if any output
rstrnt-report-log -l $LOGFILE

# Upload any logs the user may want
if [ -e $TESTPATH/logs2get ]; then
    for l in `cat $TESTPATH/logs2get`; do
        rstrnt-report-log -l $l
    done
fi

rm -f $SLABLOG
